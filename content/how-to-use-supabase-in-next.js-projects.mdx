---
title: 'å¦‚ä½•åœ¨ Next.js é¡¹ç›®ä¸­ä½¿ç”¨ supabase'
publishedAt: '2023-04-28'
summary: '"å¦‚ä½•åœ¨ Next.js é¡¹ç›®ä¸­ä½¿ç”¨ Supabase"æ˜¯ä¸€ç¯‡å…³äºæ„å»ºç°ä»£ Web åº”ç”¨çš„æ•™ç¨‹ï¼Œå…¶ä¸­è¯¦ç»†ä»‹ç»äº†å¦‚ä½•åœ¨ä½ çš„ Next.js åº”ç”¨ç¨‹åºä¸­é›†æˆSupabaseï¼Œè¿™æ˜¯ä¸€ä¸ªå¼€æºåç«¯å³æœåŠ¡å¹³å°ï¼Œå¯ä»¥æä¾›è®¤è¯ã€å®æ—¶æ•°æ®åº“å’Œå­˜å‚¨ç­‰åŠŸèƒ½ã€‚é€šè¿‡æœ¬æ–‡ï¼Œä½ å°†å­¦ä¼šå¦‚ä½•åˆ›å»º Supabase å¸æˆ·ã€åˆå§‹åŒ–åº”ç”¨ç¨‹åºã€è¿›è¡Œèº«ä»½éªŒè¯å¹¶ä¸å…¶ API è¿›è¡Œäº¤äº’ã€‚æ­¤å¤–ï¼Œä½ è¿˜å°†äº†è§£åˆ°å¦‚ä½•ä½¿ç”¨ Supabase å®ç°å®æ—¶æ•°æ®æ›´æ–°ä»¥åŠå¦‚ä½•å¤„ç†è¡¨æ ¼çš„ CRUD æ“ä½œã€‚å¦‚æœä½ æ­£åœ¨å¯»æ‰¾ä¸€ç§ç®€å•è€Œå¯é çš„æ–¹å¼æ¥ç®¡ç†ä½ çš„åº”ç”¨ç¨‹åºåç«¯ï¼Œé‚£ä¹ˆè¿™ç¯‡æ–‡ç« æ˜¯å€¼å¾—ä¸€è¯»çš„ã€‚'
tag: 'Next.js'
category: 'blog'
---

## ä»€ä¹ˆæ˜¯ supabase

[supabase](https://supabase.com/) æ˜¯ä¸€ä¸ªæ›¿ä»£ Firebase çš„å¼€æº BaaS é¡¹ç›®ã€‚å…¶æä¾›äº†å„ç§ç°ä»£åº”ç”¨æ‰€éœ€çš„ç¨³å®šã€å¼ºå¤§ã€æ˜“äºä½¿ç”¨å’Œå¯æ‰©å±•çš„åç«¯åŠŸèƒ½ã€‚Supabase åŸºäº PostgreSQL æ•°æ®åº“å’Œ RESTful API æ„å»ºï¼Œå¹¶æä¾›èº«ä»½éªŒè¯ã€å®æ—¶æ•°æ®æ¨é€ã€å­˜å‚¨å’Œå…¶ä»–ä¸€äº›å¸¸è§çš„åç«¯æœåŠ¡ã€‚

ä¸éœ€è¦ä¹°æœåŠ¡å™¨ï¼Œåªéœ€æŒæ¡ç®€å•çš„ SQL è¯­å¥å’Œæ•°æ®åº“çŸ¥è¯†å°±å¯ä»¥åˆ›å»ºä¸€ä¸ªåç«¯æœåŠ¡ã€‚å½“ç„¶å®ƒçš„åŠŸèƒ½æ˜¯éå¸¸å¼ºå¤§çš„ï¼Œè¿™ç¯‡æ–‡ç« åªä»‹ç»å¦‚ä½•åœ¨ Next.js ä¸­ä½¿ç”¨ã€‚

## ä½¿ç”¨ supabase

> å­¦ä¹ ä»»åŠ¡å†…å®¹éƒ½éœ€è¦è¯¦ç»†çš„é˜…è¯»å®˜æ–¹æ–‡æ¡£

æ ¹æ®å®˜æ–¹æ–‡æ¡£ [Use Supabase with NextJS](https://supabase.com/docs/guides/getting-started/quickstarts/nextjs) è¿™ä¸€èŠ‚çš„å†…å®¹ï¼Œä½¿ç”¨æ­¥éª¤åˆ†ä¸ºå¦‚ä¸‹å‡ æ­¥

è¿™é‡Œæˆ‘ä½¿ç”¨ supabase å­˜å‚¨åšå®¢çš„é˜…è¯»é‡

### åˆ›å»ºé¡¹ç›®å¹¶å»ºè¡¨å»ºæ•°æ®

é€šè¿‡ [https://app.supabase.com/projects](https://app.supabase.com/projects) åˆ›å»ºä¸€ä¸ªé¡¹ç›®

![new project](https://obsidian-picgo-le.oss-cn-hangzhou.aliyuncs.com/img/202304281348913.png)

é€šè¿‡ SQL ç¼–è¾‘å™¨æˆ–å›¾å½¢ç•Œé¢ DataBase åˆ›å»ºä¸€ä¸ªè¡¨åä¸º Views

![database](https://obsidian-picgo-le.oss-cn-hangzhou.aliyuncs.com/img/202304281355938.png)

è¿™é‡Œé€šè¿‡å›¾å½¢ç•Œé¢åˆ›å»ºï¼Œåœ¨ Database ä¸­ä½¿ç”¨å³ä¸Šè§’çš„ New table åˆ›å»º Views è¡¨

![create table](https://obsidian-picgo-le.oss-cn-hangzhou.aliyuncs.com/img/20230428140235.png)

åˆ—ä¸­çš„ slug è¡¨ç¤ºåšå®¢çš„ titleï¼Œcount è¡¨ç¤ºå¯¹åº”åšå®¢çš„è®¿é—®é‡

### åˆ›å»º Next.js é¡¹ç›®

```bash
npx create-next-app@latest --typescript
```

![image.png](https://obsidian-picgo-le.oss-cn-hangzhou.aliyuncs.com/img/20230428141104.png)

### å®‰è£… supabase-js

```bash
npm install @supabase/supabase-js
```

### åˆ›å»º supabase

åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»º lib æ–‡ä»¶å¤¹ï¼Œåˆ›å»ºä¸€ä¸ªåä¸º supabase.ts çš„æ–‡ä»¶

```typescript
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL as string;
const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_KEY as string;
export const supabase = createClient(supabaseUrl, supabaseKey);
```

project_url å’Œ supabase_key å¯ä»¥åœ¨é¡¹ç›®çš„è®¾ç½®é€‰é¡¹ä¸­æ‰¾åˆ°

![image.png](https://obsidian-picgo-le.oss-cn-hangzhou.aliyuncs.com/img/20230428142236.png)

åŒæ ·ä¸å»ºè®®å°† key æš´éœ²å‡ºå»ï¼Œå¯ä»¥å­˜åœ¨ env.local ä¸­

> ğŸ’¡ tips: åœ¨ Next.js ä¸­ä½¿ç”¨ env.localï¼Œéœ€è¦åŠ ä¸Š NEXT_PUBLIC å‰ç¼€ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚

### CRUD

è¯¦ç»†çš„å‘½ä»¤å¯ä»¥é€šè¿‡ [JavaScript](https://supabase.com/docs/reference/javascript/installing) æ–‡æ¡£æŸ¥è¯¢

å½“æ‰“å¼€åšå®¢æ–‡ç« é¡µé¢æ—¶ï¼Œéœ€è¦æŸ¥è¯¢å½“å‰åšå®¢çš„é˜…è¯»é‡ï¼Œå¯ä»¥ä½¿ç”¨

```typescript
fetch(`/api/views`);
```

åœ¨ pages/api/views ç›®å½•ä¸‹åˆ›å»º index.ts

```typescript
import { supabase } from '@/lib/supabase';
import type { NextApiRequest, NextApiResponse } from 'next';

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  try {
    let { data } = await supabase.from('Views').select('*');
    return res.status(200).json(data);
  } catch (e: any) {
    console.log(e);
    return res.status(500).json({ message: e.message });
  }
}
```

é€šè¿‡å†™ç±»ä¼¼äº sql è¯­å¥ï¼Œå¯ä»¥ä» Views è¡¨ä¸­è·å–å…¨éƒ¨çš„æ•°æ®

ä¹Ÿå¯ä»¥é€šè¿‡ post ä¼ å‚å°† slug ä¼ è¿›æ¥ï¼ŒæŸ¥è¯¢å¯¹åº”çš„æ•°æ®

åŒæ—¶å½“æ‰“å¼€åšå®¢æ–‡ç« é¡µé¢æ—¶ï¼Œä¹Ÿéœ€è¦å¯¹å½“å‰åšå®¢çš„é˜…è¯»é‡åŠ ä¸€ï¼Œå°±å¯ä»¥ç”¨è¿‡ post è¯·æ±‚å°† slug å‚æ•°ä¼ å…¥

```typescript
fetch(`/api/views/${slug}`, {
  method: 'POST'
});
```

åœ¨ pages/api/views ç›®å½•ä¸‹åˆ›å»º `[slug].ts`

```typescript
import { supabase } from '@/lib/supabase';
import type { NextApiRequest, NextApiResponse } from 'next';

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  try {
    const slug = req.query?.slug as string;
    if (!slug) {
      return res.status(400).json({ message: 'Slug is required.' });
    }

    const { data } = await supabase
      .from('Views')
      .select('count')
      .eq('slug', slug);

    const views = !data?.length ? 0 : Number(data[0].count);

    if (req.method === 'POST') {
      if (views === 0) {
        await supabase.from('Views').insert({ count: views + 1, slug: slug });

        return res.status(200).json({
          total: views + 1
        });
      } else {
        await supabase
          .from('views')
          .update({ count: views + 1 })
          .eq('slug', slug);
        return res.status(200).json({
          total: views + 1
        });
      }
    }

    if (req.method === 'GET') {
      return res.status(200).json({ total: views });
    }
  } catch (e: any) {
    console.log(e);
    return res.status(500).json({ message: e.message });
  }
}
```

æ–°å»ºä½¿ç”¨ insertï¼Œæ›´æ–°ä½¿ç”¨ updateã€‚è¿™æ ·å°±å¯ä»¥è®²é˜…è¯»é‡å­˜å‚¨åˆ° supabase ä¸­

## å…¶ä»–åŠŸèƒ½

åŒæ—¶ supabase ä¹Ÿæ”¯æŒ bucket å­˜å‚¨åŠŸèƒ½ã€‚æˆ‘çš„é¡¹ç›®ä¸­å°† og image å­˜å‚¨åœ¨ supabase ä¸­

![image.png](https://obsidian-picgo-le.oss-cn-hangzhou.aliyuncs.com/img/20230428145812.png)

å‡†å¤‡åé¢çš„é¡¹ç›®ä¸­ç»§ç»­ä½¿ç”¨ supabaseï¼Œæ›¿ä»£ Firebaseã€‚
