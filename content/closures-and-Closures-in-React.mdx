---
title: 'Closures and Closures in React'
publishedAt: '2022-05-08'
summary: 'Closures and Closures in React'
---

> ğŸ¤º é—­åŒ…å°±æ˜¯å¯ä»¥è¯»å–å…¶ä»–å‡½æ•°å†…éƒ¨å˜é‡çš„å‡½æ•° â€” [é˜®ä¸€å³°åšå®¢](https://www.ruanyifeng.com/blog/2009/08/learning_javascript_closures.html)

## é—­åŒ…å¸¸è§çš„è€ƒé¢˜

### è¾“å‡ºçš„ç»“æœ

```JavaScript
for (var i = 0; i < 10; i++) {
  setTimeout(() => {
    console.log(i);
  }, 1000);
}
// ä¸€ç§’åï¼Œè¾“å‡ºäº† 10 ä¸ª 10
```

å‡ºç°è¿™ç§åŸå› å°±æ˜¯ç”¨ `var` å£°æ˜çš„å˜é‡ï¼Œæ²¡æœ‰å—çº§ä½œç”¨åŸŸï¼Œæ‰€ä»¥é™å®šä¸äº† `var` å£°æ˜å˜é‡çš„è®¿é—®èŒƒå›´

é—®ï¼šå¦‚æœè¦è¾“å‡º 0 - 9 é‚£è¯¥æ€ä¹ˆæ”¹å‘¢

1.ç®€å•æ–¹æ³•ï¼šå°† `var` æ”¹æˆ `let`

```JavaScript
// ç®€å•ã€‚å¸¸ç”¨æ”¹æ³•ã€‚å°† var æ”¹æˆ let
for (let i = 0; i < 10; i++) {
  setTimeout(() => {
    console.log(i);
  }, 1000);
}
```

2.å°±æ˜¯ä½¿ç”¨ [IIFE](https://developer.mozilla.org/zh-CN/docs/Glossary/IIFE)

```JavaScript
// ä½¿ç”¨ iife å®ç°å—çº§ä½œç”¨åŸŸ
// _i ä¿å­˜ç€ iife å¯¹ i çš„å¼•ç”¨
// å…¶å®ä¹Ÿå°±æ˜¯é—­åŒ…
for (var i = 0; i < 10; i++) {
  ((_i) => {
    setTimeout(() => {
      console.log(_i);
    }, 1000);
  })(i);
}
```

3.å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ `setTimeout` æœ¬èº«è§£å†³ã€‚æ¥å—ç¬¬ä¸‰ä¸ªå‚æ•°

```JavaScript
for (var i = 0; i < 10; i++) {
  setTimeout((_i) => {
      console.log(_i);
    }, 1000, i);
}
```

## `React` ä¸ é—­åŒ…çš„é—®é¢˜

### `useState` çš„é—­åŒ…é—®é¢˜

```JavaScript
import React, { useState } from 'react';
function FunComponent() {
  const [count, setCount] = useState(0);
  const handleClick = () => {
    setCount(count + 1);
    setTimeout(() => {
      console.log('count', count);
    }, 1000);
  };
  return (
    <div>
      <p>ä½ ç‚¹å‡»äº† {count} æ¬¡</p>
      <button onClick={handleClick}>ç‚¹å‡»</button>
    </div>
  );
}
export default FunComponent;
```

é—®ï¼šå¿«é€Ÿç‚¹å‡»ä¸‰æ¬¡åï¼Œè¿™æ®µä»£ç ä¼šè¾“å…¥ä»€ä¹ˆï¼Ÿ

æ­£å¸¸çœ‹å¥½åƒåº”è¯¥æ˜¯è¾“å‡º ä¸‰ä¸ª 3ï¼Œä½†æ˜¯å®é™…ä¸Šæ˜¯ 0ï¼Œ1ï¼Œ2ï¼Œè¿™æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´çš„å‘¢ï¼Ÿ

å…¶å®è¿™ä¹Ÿæ˜¯å’Œé—­åŒ…æœ‰å…³ç³»çš„ï¼Œ`setTimeout` å›è°ƒå‡½æ•°å°±æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œé‡Œé¢çš„ `count` çš„å€¼æ¥è‡ªäºå‡½æ•°ç»„ä»¶ `FunComponent` `state` çš„ `count` ï¼›è€Œä¸”è¿™ä¸ª `count `åœ¨é—­åŒ…ä¸­æ˜¯ä¸ä¼šè¢«é”€æ¯çš„

æ‰€ä»¥å…·ä½“çš„è°ƒç”¨è¿‡ç¨‹å¦‚ä¸‹ï¼š

- ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼Œç¬¬ä¸€ä¸ªå®šæ—¶å™¨å›è°ƒå‡½æ•°è·å–çš„ `count` ç­‰äº 0ï¼Œä¸€ç§’ä¹‹åå°±ä¼šæ‰“å° 0
- ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œ`count` å˜ä¸º 1
- ç¬¬äºŒæ¬¡ç‚¹å‡»ï¼Œç¬¬äºŒä¸ªå®šæ—¶å™¨å›è°ƒå‡½æ•°è·å–çš„ `count` æ­¤æ—¶ç­‰äº 1ï¼Œä¸€ç§’ä¹‹åå°±ä¼šæ‰“å° 1
- ä¹‹åçš„ä»¥æ­¤ç±»æ¨

é‚£ä¹ˆä¸ºäº†è®©æ‰“å°å‡º 3ï¼Œ3ï¼Œ3ï¼Œè¯¥æ€ä¹ˆä¿®æ”¹å‘¢ï¼Ÿ

### ä½¿ç”¨ `useRef` æ¥è§£å†³

```JavaScript
+ import React, { useState, useRef } from 'react';
function FunComponent() {
  const [count, setCount] = useState(0);
+  const countRef = useRef(count);
  const handleClick = () => {
    setCount(count + 1);
+    countRef.current = count + 1;
    setTimeout(() => {
      console.log('count', count);
+      console.log('countRef.current', countRef.current);
    }, 1000);
  };
  return (
    <div>
      <p>ä½ ç‚¹å‡»äº† {count} æ¬¡</p>
      <button onClick={handleClick}>ç‚¹å‡»</button>
    </div>
  );
}
export default FunComponent;
```

![image.png](https://cdn.hashnode.com/res/hashnode/image/upload/v1666358607350/LECb0gGCQ.png align="left")

é€šè¿‡æ·»åŠ ä¸Šé¢å‡ è¡Œä»£ç å°±å¯ä»¥å®ç°æ‰“å° 3ï¼Œ3ï¼Œ3 çš„åŠŸèƒ½ã€‚

ä½†æ˜¯è¿™æ ·æ¯æ¬¡éƒ½è¦å†™ `countRef.current = count + 1` å¾ˆä¸ä¼˜é›…ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼æ¥è¿›è¡Œä¼˜åŒ–

### ä½¿ç”¨ `useEffect` æ¥ä¼˜åŒ–

```JavaScript
import React, { useState, useRef, useEffect } from 'react';
function FunComponent() {
  const [count, setCount] = useState(0);
  const countRef = useRef(count);
  useEffect(() => {
    countRef.current = count;
  });
  const handleClick = () => {
    setCount(count + 1);
    setTimeout(() => {
      console.log('count', count);
      console.log('countRef.current', countRef.current);
    }, 1000);
  };
  return (
    <div>
      <p>ä½ ç‚¹å‡»äº† {count} æ¬¡</p>
      <button onClick={handleClick}>ç‚¹å‡»</button>
    </div>
  );
}
export default FunComponent;
```

ç»„ä»¶é‡æ–°æ¸²æŸ“åå°±ä¼šè§¦å‘ `useEffect` æ–¹æ³•ï¼Œå°†æœ€æ–°çš„å€¼èµ‹ç»™ `current` å³å¯ï¼Œæ— éœ€å†å°† `count + 1`

ä½†æ˜¯è¿˜æ˜¯å¯ä»¥æ¥ç€ä¼˜åŒ–ï¼Œä½¿ç”¨`è‡ªå®šä¹‰ hook` æ¥å®ç°è·å–æœ€æ–°çš„ `state`

### ä½¿ç”¨ `è‡ªå®šä¹‰hook` è·å–æœ€æ–°çš„ `state`

```JavaScript
import { useEffect, useRef } from 'react';
/**
 * è‡ªå®šä¹‰Hook -- è·å–æœ€æ–°çš„ state çš„å€¼
 * @param value
 */
export const useGetCurrentValue = (value: any) => {
  const ref = useRef(value);
  useEffect(() => {
    ref.current = value;
  }, [value]);
  return ref;
};
```

```JavaScript
import React, { useState } from 'react';
import { useGetCurrentValue } from '../../hook/useGetCurrentValue';
function FunComponent() {
  const [count, setCount] = useState(0);
  const countRef = useGetCurrentValue(count);
  const handleClick = () => {
    setCount(count + 1);
    setTimeout(() => {
      console.log('count', count);
      console.log('countRef.current', countRef.current);
    }, 1000);
  };
  return (
    <div>
      <p>ä½ ç‚¹å‡»äº† {count} æ¬¡</p>
      <button onClick={handleClick}>ç‚¹å‡»</button>
    </div>
  );
}
export default FunComponent;
```

é—®ï¼šå¦‚æœè‡ªå®šä¹‰ hook return çš„æ˜¯ ref.currentï¼Œä¸ºä»€ä¹ˆä¼šæœ‰é—®é¢˜ ?

## `useEffect` çš„é—­åŒ…é—®é¢˜

åŒæ ·ï¼Œåœ¨ `useEffect` ä¸­ä¹Ÿæœ‰è¿™æ ·çš„é—®é¢˜

```JavaScript
import React, { useEffect, useState } from 'react';
function FunComponent() {
  const [count, setCount] = useState(0);
  useEffect(() => {
    setInterval(() => {
      setCount(count + 1);
    }, 1000);
  }, []);
  return (
    <div>
      <p>{count}</p>
    </div>
  );
}
export default FunComponent;
```

ä¼šå‘ç°ï¼Œé¡µé¢ä¸Šçš„ `count` åˆ° 1 ä¹‹åå°±ä¸å˜äº†ï¼Œè¿˜ä»¥ä¸ºæ˜¯å¡äº†ã€‚å‡ºç°è¿™ç§åŸå› è¿˜æ˜¯å› ä¸ºé—­åŒ…ã€‚`setInterval` çš„å›è°ƒå‡½æ•°è¿˜æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œ`count ` å°±æ˜¯åˆå§‹å€¼ 0ï¼Œå¹¶ä¸”ä¸ä¼šè¢«é”€æ¯ä¸”ä¸€ç›´å­˜åœ¨ï¼Œæ‰€ä»¥å°±ç›¸å½“äºä¸€ç›´æ˜¯ 0 + 1ï¼Œæ‰€ä»¥ `count` ä¸€ç›´æ˜¯ 1ã€‚

è§£å†³æ–¹æ³•å¦‚ä¸‹ï¼š

```JavaScript
import React, { useEffect, useState } from 'react';
function FunComponent() {
  const [count, setCount] = useState(0);
  useEffect(() => {
    setInterval(() => {
      setCount((c) => c + 1);
    }, 1000);
  }, []);
  return (
    <div>
      <p>{count}</p>
    </div>
  );
}
export default FunComponent;
```

è¿™æ ·å°±å¯ä»¥è·å–åˆ°æœ€æ–°çš„ `state` äº†

é—­åŒ…çš„å†…å®¹å°±åˆ°è¿™é‡Œäº†ã€‚åé¢å†è®²è®² `useRef` çš„åŸç† ğŸ‘‹ğŸ»
